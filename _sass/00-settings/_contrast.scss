/* ==========================================================================
  Tillerstead WCAG 2.1 Contrast Utilities
  Authoritative: Follows WCAG 2.1 (AA/AAA) and TCNA 2024 accessibility standards
  Reference: https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum.html
  ========================================================================== */

/* --------------------------------------------------------------------------
  WCAG 2.1 Contrast Ratios (Per TCNA/NJ HIC Compliance)
  - AA Normal Text: 4.5:1 (required)
  - AA Large Text (18pt/24px+): 3:1 (required)
  - AAA Normal Text: 7:1 (recommended)
  - AAA Large Text: 4.5:1 (recommended)
  -------------------------------------------------------------------------- */

// Remove units from numeric values (for calculations)
@function strip-unit($value) {
  @return math.div($value, $value * 0 + 1);
}

// Convert hex color to RGB map (0-255)
@function hex-to-rgb($hex) {
  @return (
   red: red($hex),
   green: green($hex),
   blue: blue($hex)
  );
}

// Convert 8-bit RGB channel to linear RGB (0-1)
@function linearize-channel($channel) {
  $channel: math.div($channel, 255);
  @if $channel <= 0.03928 {
   @return math.div($channel, 12.92);
  }
  @return math.pow(math.div($channel + 0.055, 1.055), 2.4);
}

// Calculate relative luminance (per WCAG 2.1 formula)
@function luminance($color) {
  $rgb: hex-to-rgb($color);
  $r: linearize-channel(map-get($rgb, red));
  $g: linearize-channel(map-get($rgb, green));
  $b: linearize-channel(map-get($rgb, blue));
  @return 0.2126 * $r + 0.7152 * $g + 0.0722 * $b;
}

// Contrast ratio between two colors (returns 1â€“21)
@function contrast-ratio($foreground, $background) {
  $lum1: luminance($foreground);
  $lum2: luminance($background);
  $lighter: math.max($lum1, $lum2);
  $darker: math.min($lum1, $lum2);
  @return math.div($lighter + 0.05, $darker + 0.05);
}

// WCAG AA: Normal text (4.5:1)
@function meets-aa-normal($foreground, $background) {
  @return contrast-ratio($foreground, $background) >= 4.5;
}

// WCAG AA: Large text (3:1)
@function meets-aa-large($foreground, $background) {
  @return contrast-ratio($foreground, $background) >= 3;
}

// WCAG AAA: Normal text (7:1)
@function meets-aaa-normal($foreground, $background) {
  @return contrast-ratio($foreground, $background) >= 7;
}

// Auto-selects optimal text color (light/dark) for background
@function auto-text-color($background, $light: #ffffff, $dark: #1c231f) {
  $light-contrast: contrast-ratio($light, $background);
  $dark-contrast: contrast-ratio($dark, $background);
  @return if($light-contrast > $dark-contrast, $light, $dark);
}

// Returns accessible text color meeting minimum contrast (default AA)
@function accessible-text-color($background, $min-contrast: 4.5, $light: #ffffff, $dark: #1c231f) {
  $light-contrast: contrast-ratio($light, $background);
  $dark-contrast: contrast-ratio($dark, $background);

  @if $light-contrast >= $min-contrast and $dark-contrast >= $min-contrast {
   @return if($light-contrast > $dark-contrast, $light, $dark);
  } @else if $light-contrast >= $min-contrast {
   @return $light;
  } @else if $dark-contrast >= $min-contrast {
   @return $dark;
  } @else {
   @warn "Non-compliant: Neither text color meets minimum contrast #{$min-contrast}:1 on background #{$background}. Light: #{$light-contrast}, Dark: #{$dark-contrast}";
   @return if($light-contrast > $dark-contrast, $light, $dark);
  }
}

// Lighten color until it meets minimum contrast (for dark backgrounds)
@function lighten-until-contrast($color, $background, $min-contrast: 4.5, $max-iterations: 20) {
  $result: $color;
  $iteration: 0;
  @while contrast-ratio($result, $background) < $min-contrast and $iteration < $max-iterations {
   $result: lighten($result, 5%);
   $iteration: $iteration + 1;
  }
  @if $iteration >= $max-iterations {
   @warn "Contrast adjustment failed: #{$color} on #{$background} did not reach #{$min-contrast}:1 after #{$max-iterations} steps.";
  }
  @return $result;
}

// Darken color until it meets minimum contrast (for light backgrounds)
@function darken-until-contrast($color, $background, $min-contrast: 4.5, $max-iterations: 20) {
  $result: $color;
  $iteration: 0;
  @while contrast-ratio($result, $background) < $min-contrast and $iteration < $max-iterations {
   $result: darken($result, 5%);
   $iteration: $iteration + 1;
  }
  @if $iteration >= $max-iterations {
   @warn "Contrast adjustment failed: #{$color} on #{$background} did not reach #{$min-contrast}:1 after #{$max-iterations} steps.";
  }
  @return $result;
}

// Adjust color to ensure minimum contrast (AA/AAA as required)
@function ensure-contrast($color, $background, $min-contrast: 4.5) {
  $current-contrast: contrast-ratio($color, $background);
  @if $current-contrast >= $min-contrast {
   @return $color;
  }
  $bg-luminance: luminance($background);
  @if $bg-luminance > 0.5 {
   @return darken-until-contrast($color, $background, $min-contrast);
  } @else {
   @return lighten-until-contrast($color, $background, $min-contrast);
  }
}

/* --------------------------------------------------------------------------
  Usage Examples (for theme developers)
  --------------------------------------------------------------------------
  // color: auto-text-color(#f9f5eb); // Returns #1c231f for light background
  // color: accessible-text-color(#0b6b5c, 4.5); // Returns #ffffff for dark emerald
  // color: ensure-contrast(#6b726d, #f9f5eb, 4.5); // Darkens gray until readable
  // $ratio: contrast-ratio(#1c231f, #f9f5eb); // Returns ~15.7:1
  -------------------------------------------------------------------------- */

/* --------------------------------------------------------------------------
  Debug Mixin: Print contrast ratios and compliance status
  -------------------------------------------------------------------------- */
@mixin debug-contrast($fg, $bg) {
  $ratio: contrast-ratio($fg, $bg);
  @debug "Contrast: #{$fg} on #{$bg} = #{$ratio}:1";
  @debug "AA Normal (4.5:1): #{meets-aa-normal($fg, $bg)}";
  @debug "AA Large (3:1): #{meets-aa-large($fg, $bg)}";
  @debug "AAA Normal (7:1): #{meets-aaa-normal($fg, $bg)}";
}
