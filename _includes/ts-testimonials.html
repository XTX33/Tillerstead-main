<!-- htmlhint doctype-first:false -->

{% comment %}
Testimonials include
- Reads from `include.reviews` when provided, otherwise `site.data.reviews.reviews`.
- Optional params: heading, eyebrow, limit.
- quote_html should be HTML-safe snippets sourced from Thumbtack via scripts/sync_thumbtack_reviews.js.
{% endcomment %}

{% assign reviews = include.reviews | default: site.data.reviews.reviews | default: [] %}
{% if include.limit %}
  {% assign reviews = reviews | slice: 0, include.limit %}
{% endif %}

{% assign heading = include.heading | default: 'Client testimonials' %}
{% assign eyebrow = include.eyebrow | default: 'Verified reviews' %}

{% assign section_id = include.section_id | default: 'ts-testimonials' %}
{% assign heading_id = include.heading_id | default: section_id | append: '-title' %}

<section class="ts-testimonials ts-section" aria-labelledby="{{ heading_id }}" style="background-image: url('/assets/img/patterns/vesica-piscis.svg'); background-size: 280px 280px; background-position: center; background-attachment: fixed;">
  <div class="container">
    <header class="ts-testimonials__header section-header">
      {% if eyebrow %}<p class="eyebrow text-accent">{{ eyebrow }}</p>{% endif %}
      <h2 id="{{ heading_id }}" class="heading-2">{{ heading }}</h2>
    </header>

    {% if reviews and reviews.size gt 0 %}
      {%- comment -%}
      Reorder reviews so the longest one appears near the middle (or 2nd for small/even counts).
      This is done at render-time to avoid needing to mutate arrays.
      {%- endcomment -%}

      {% assign longest_index = -1 %}
      {% assign longest_len = 0 %}
      {% assign longest_review = nil %}
      {% for review in reviews %}
        {% assign _len = review.quote_html | strip_html | strip | size %}
        {% if _len > longest_len %}
          {% assign longest_len = _len %}
          {% assign longest_index = forloop.index0 %}
          {% assign longest_review = review %}
        {% endif %}
      {% endfor %}

      {% assign _size = reviews.size %}
      {% if _size == 1 %}
        {% assign target_pos = 0 %}
      {% elsif _size == 2 %}
        {% assign target_pos = 1 %}
      {% else %}
        {%- comment -%}“Middle-left” position so even counts land on the 2nd/3rd item.{%- endcomment -%}
        {% assign target_pos = _size | minus: 1 | divided_by: 2 %}
      {% endif %}

      <div class="ts-testimonials__grid" role="list">
        {% assign rendered_pos = 0 %}
        {% assign longest_rendered = false %}
        {% for review in reviews %}
          {%- if rendered_pos == target_pos and longest_rendered == false and longest_review -%}
            <article class="ts-testimonial" role="listitem" aria-label="Testimonial from {{ longest_review.author | default: 'Client' }}">
              {% assign rating_value = longest_review.rating | default: 5 %}
              {% assign rating_max = longest_review.rating_max | default: 5 %}
              <blockquote class="ts-testimonial__quote">
                <div class="ts-testimonial__quote-text">{{ longest_review.quote_html }}</div>
              </blockquote>

              <div class="ts-testimonial__rating" aria-label="Rated {{ rating_value }} out of {{ rating_max }} stars">
                <span class="sr-only">Rated {{ rating_value }} out of {{ rating_max }} stars</span>
                <div class="ts-testimonial__stars" aria-hidden="true">
                  {% for i in (1..rating_max) %}
                    <span class="ts-testimonial__star{% if i lte rating_value %} ts-testimonial__star--filled{% endif %}">
                      {% if i lte rating_value %}★{% else %}☆{% endif %}
                    </span>
                  {% endfor %}
                </div>
              </div>

              <footer class="ts-testimonial__meta" aria-label="Review details">
                <p class="ts-testimonial__byline">
                  {% if longest_review.author %}<span class="ts-testimonial__author">{{ longest_review.author }}</span>{% endif %}
                  {% if longest_review.location %}<span class="ts-testimonial__location"> · {{ longest_review.location }}</span>{% endif %}
                  {% if longest_review.job_type %}<span class="ts-testimonial__job"> · {{ longest_review.job_type }}</span>{% endif %}
                  {% if longest_review.date %}<span class="ts-testimonial__date"> · {{ longest_review.date | date: "%b %Y" }}</span>{% endif %}
                </p>
                {% if longest_review.badges and longest_review.badges.size gt 0 %}
                  <ul class="ts-testimonial__badges" aria-label="Review badges">{%- for badge in longest_review.badges -%}<li class="ts-testimonial__badge">{{ badge }}</li>{%- endfor -%}</ul>
                {% endif %}
                {% if longest_review.url and longest_review.platform %}
                  <a href="{{ longest_review.url }}" 
                     class="ts-testimonial__verify" 
                     target="_blank" 
                     rel="noopener nofollow"
                     aria-label="Verify this review on {{ longest_review.platform }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                      <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    <span>Verified on {{ longest_review.platform }}</span>
                  </a>
                {% endif %}
              </footer>
            </article>
            {% assign rendered_pos = rendered_pos | plus: 1 %}
            {% assign longest_rendered = true %}
          {%- endif -%}

          {%- if forloop.index0 == longest_index -%}
            {%- continue -%}
          {%- endif -%}

          {% assign quote_text = review.quote_html | strip_html | strip %}
          {% assign is_long = false %}
          {% if quote_text.size > 300 %}
            {% assign is_long = true %}
          {% endif %}

          {% assign rating_value = review.rating | default: 5 %}
          {% assign rating_max = review.rating_max | default: 5 %}
          
          <article class="ts-testimonial{% if is_long %} ts-testimonial--expandable{% endif %}" role="listitem" aria-label="Testimonial from {{ review.author | default: 'Client' }}">
            <blockquote class="ts-testimonial__quote">
              <div class="ts-testimonial__quote-text">
                {% if is_long %}
                  <span class="ts-testimonial__quote-preview">{{ review.quote_html | strip_html | truncate: 280, '...' }}</span>
                  <span class="ts-testimonial__quote-full" style="display: none;">{{ review.quote_html }}</span>
                  <button type="button" class="ts-testimonial__read-more" aria-expanded="false">
                    <span class="ts-testimonial__read-more-text">Read more</span>
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <polyline points="2 4 6 8 10 4"></polyline>
                    </svg>
                  </button>
                {% else %}
                  {{ review.quote_html }}
                {% endif %}
              </div>
            </blockquote>

            <div class="ts-testimonial__rating" aria-label="Rated {{ rating_value }} out of {{ rating_max }} stars">
              <span class="sr-only">Rated {{ rating_value }} out of {{ rating_max }} stars</span>
              <div class="ts-testimonial__stars" aria-hidden="true">
                {% for i in (1..rating_max) %}
                  <span class="ts-testimonial__star{% if i lte rating_value %} ts-testimonial__star--filled{% endif %}">
                    {% if i lte rating_value %}★{% else %}☆{% endif %}
                  </span>
                {% endfor %}
              </div>
            </div>

            <footer class="ts-testimonial__meta" aria-label="Review details">
              <p class="ts-testimonial__byline">
                {% if review.author %}<span class="ts-testimonial__author">{{ review.author }}</span>{% endif %}
                {% if review.location %}<span class="ts-testimonial__location"> · {{ review.location }}</span>{% endif %}
                {% if review.job_type %}<span class="ts-testimonial__job"> · {{ review.job_type }}</span>{% endif %}
                {% if review.date %}<span class="ts-testimonial__date"> · {{ review.date | date: "%b %Y" }}</span>{% endif %}
              </p>
              {% if review.badges and review.badges.size gt 0 %}
                <ul class="ts-testimonial__badges" aria-label="Review badges">{%- for badge in review.badges -%}<li class="ts-testimonial__badge">{{ badge }}</li>{%- endfor -%}</ul>
              {% endif %}
              {% if review.url and review.platform %}
                <a href="{{ review.url }}" 
                   class="ts-testimonial__verify" 
                   target="_blank" 
                   rel="noopener nofollow"
                   aria-label="Verify this review on {{ review.platform }}">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <span>Verified on {{ review.platform }}</span>
                </a>
              {% endif %}
            </footer>
          </article>
          {% assign rendered_pos = rendered_pos | plus: 1 %}
        {% endfor %}

        {%- if longest_rendered == false and longest_review -%}
          <article class="ts-testimonial" role="listitem" aria-label="Testimonial from {{ longest_review.author | default: 'Client' }}">
            {% assign rating_value = longest_review.rating | default: 5 %}
            {% assign rating_max = longest_review.rating_max | default: 5 %}
            <blockquote class="ts-testimonial__quote">
              <div class="ts-testimonial__quote-text">{{ longest_review.quote_html }}</div>
            </blockquote>

            <div class="ts-testimonial__rating" aria-label="Rated {{ rating_value }} out of {{ rating_max }} stars">
              <span class="sr-only">Rated {{ rating_value }} out of {{ rating_max }} stars</span>
              <div class="ts-testimonial__stars" aria-hidden="true">
                {% for i in (1..rating_max) %}
                  <span class="ts-testimonial__star{% if i lte rating_value %} ts-testimonial__star--filled{% endif %}">
                    {% if i lte rating_value %}★{% else %}☆{% endif %}
                  </span>
                {% endfor %}
              </div>
            </div>

            <footer class="ts-testimonial__meta" aria-label="Review details">
              <p class="ts-testimonial__byline">
                {% if longest_review.author %}<span class="ts-testimonial__author">{{ longest_review.author }}</span>{% endif %}
                {% if longest_review.location %}<span class="ts-testimonial__location"> · {{ longest_review.location }}</span>{% endif %}
                {% if longest_review.job_type %}<span class="ts-testimonial__job"> · {{ longest_review.job_type }}</span>{% endif %}
                {% if longest_review.date %}<span class="ts-testimonial__date"> · {{ longest_review.date | date: "%b %Y" }}</span>{% endif %}
              </p>
              {% if longest_review.badges and longest_review.badges.size gt 0 %}
                <ul class="ts-testimonial__badges" aria-label="Review badges">{%- for badge in longest_review.badges -%}<li class="ts-testimonial__badge">{{ badge }}</li>{%- endfor -%}</ul>
              {% endif %}
              {% if longest_review.url and longest_review.platform %}
                <a href="{{ longest_review.url }}" 
                   class="ts-testimonial__verify" 
                   target="_blank" 
                   rel="noopener nofollow"
                   aria-label="Verify this review on {{ longest_review.platform }}">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <span>Verified on {{ longest_review.platform }}</span>
                </a>
              {% endif %}
            </footer>
          </article>
        {%- endif -%}
      </div>
    {% else %}
      <p class="ts-testimonials__empty">Reviews will appear here once they are synced.</p>
    {% endif %}
  </div>
</section>
