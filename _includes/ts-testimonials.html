<!-- htmlhint doctype-first:false -->

{% comment %}
Testimonials include
- Reads from `include.reviews` when provided, otherwise `site.data.reviews.reviews`.
- Optional params: heading, eyebrow, limit.
- quote_html should be HTML-safe snippets sourced from Thumbtack via scripts/sync_thumbtack_reviews.js.
{% endcomment %}

{% assign reviews = include.reviews | default: site.data.reviews.reviews | default: [] %}
{% if include.limit %}
  {% assign reviews = reviews | slice: 0, include.limit %}
{% endif %}

{% assign heading = include.heading | default: 'Client testimonials' %}
{% assign eyebrow = include.eyebrow | default: 'Verified reviews' %}

{% assign section_id = include.section_id | default: 'ts-testimonials' %}
{% assign heading_id = include.heading_id | default: section_id | append: '-title' %}

<section class="ts-testimonials ts-section" aria-labelledby="{{ heading_id }}">
  <div class="container">
    <header class="ts-testimonials__header section-header">
      {% if eyebrow %}<p class="eyebrow text-accent">{{ eyebrow }}</p>{% endif %}
      <h2 id="{{ heading_id }}" class="heading-2">{{ heading }}</h2>
    </header>

    {% if reviews and reviews.size gt 0 %}
      <div class="ts-testimonials__grid" role="list">
        {% for review in reviews %}
          {% assign rating_value = review.rating | default: 5 %}
          {% assign rating_max = review.rating_max | default: 5 %}
          <article class="ts-testimonial" role="listitem" aria-label="Testimonial from {{ review.author | default: 'Client' }}">
            <blockquote class="ts-testimonial__quote">
              <div class="ts-testimonial__quote-text">{{ review.quote_html }}</div>
            </blockquote>

            <div class="ts-testimonial__rating" aria-label="Rated {{ rating_value }} out of {{ rating_max }} stars">
              <span class="sr-only">Rated {{ rating_value }} out of {{ rating_max }} stars</span>
              <div class="ts-testimonial__stars" aria-hidden="true">
                {% for i in (1..rating_max) %}
                  <span class="ts-testimonial__star{% if i lte rating_value %} ts-testimonial__star--filled{% endif %}">
                    {% if i lte rating_value %}★{% else %}☆{% endif %}
                  </span>
                {% endfor %}
              </div>
            </div>

            <footer class="ts-testimonial__meta" aria-label="Review details">
              <p class="ts-testimonial__byline">
                {% if review.author %}<span class="ts-testimonial__author">{{ review.author }}</span>{% endif %}
                {% if review.location %}<span class="ts-testimonial__location"> · {{ review.location }}</span>{% endif %}
                {% if review.job_type %}<span class="ts-testimonial__job"> · {{ review.job_type }}</span>{% endif %}
                {% if review.date %}<span class="ts-testimonial__date"> · {{ review.date | date: "%b %Y" }}</span>{% endif %}
              </p>
              {% if review.badges and review.badges.size gt 0 %}
                <ul class="ts-testimonial__badges" aria-label="Review badges">{%- for badge in review.badges -%}<li class="ts-testimonial__badge">{{ badge }}</li>{%- endfor -%}</ul>
              {% endif %}
              {% if review.url and review.platform %}
                <a href="{{ review.url }}" 
                   class="ts-testimonial__verify" 
                   target="_blank" 
                   rel="noopener nofollow"
                   aria-label="Verify this review on {{ review.platform }}">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                  <span>Verified on {{ review.platform }}</span>
                </a>
              {% endif %}
            </footer>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p class="ts-testimonials__empty">Reviews will appear here once they are synced.</p>
    {% endif %}
  </div>
</section>
