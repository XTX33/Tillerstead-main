{%- comment -%}
  Global and per-page scripts
  - contrast.js: high-visibility contrast system (WCAG AAA)
  - main.js: site-wide behaviors (nav, theme toggle, smooth scroll, forms)
  - page.scripts: optional array of additional script paths in front matter
  
  IMPORTANT: Each script should only be loaded ONCE.
  Duplicate script tags can cause infinite loops and crash Safari on iOS.
{%- endcomment -%}

<script
  defer
  src="{{ '/assets/js/contrast.js' | relative_url }}?v={{ site.version | default: site.github.build_revision | default: '10' }}"
  crossorigin="anonymous">
</script>

<script
  defer
  src="{{ '/assets/js/main.js' | relative_url }}?v={{ site.version | default: site.github.build_revision | default: '10' }}"
  crossorigin="anonymous">
</script>

<!-- Boss Theme Interactions -->
<script
  defer
  src="{{ '/assets/js/boss-interactions.js' | relative_url }}?v={{ site.version | default: site.github.build_revision | default: '10' }}"
  crossorigin="anonymous">
</script>

{% if page.scripts %}
  {% for src in page.scripts %}
    <script
      defer
      src="{{ src | relative_url }}?v={{ site.version | default: site.github.build_revision | default: '10' }}">
    </script>
  {% endfor %}
{% endif %}

<!-- Tillerstead mobile nav script (namespaced, safe) -->
<script>
  (function(){
    const header = document.querySelector('.site-header');
    if(!header) return;

    const toggle = header.querySelector('#nav-toggle');
    const navContainer = header.querySelector('[data-nav-container]');
    const nav = header.querySelector('#site-nav');
    const closeBtn = header.querySelector('[data-nav-close]');
    const overlay = header.querySelector('[data-nav-overlay]');
    if(!toggle || !nav || !navContainer) return;

    const focusableSelectors = 'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])';
    let lastFocused = null;

    const isOpen = () => navContainer.classList.contains('is-open');

    const setState = (open) => {
      navContainer.classList.toggle('is-open', open);
      document.body.classList.toggle('nav-open', open);
      nav.setAttribute('aria-expanded', String(open));
      toggle.setAttribute('aria-expanded', String(open));

      if(open) {
        lastFocused = document.activeElement;
        const focusable = nav.querySelector(focusableSelectors);
        if(focusable) {
          focusable.focus({ preventScroll: true });
        }
      } else if(lastFocused && typeof lastFocused.focus === 'function') {
        lastFocused.focus();
      }
    };

    const toggleNav = () => setState(!isOpen());
    const closeNav = () => setState(false);

    toggle.addEventListener('click', toggleNav);
    closeBtn?.addEventListener('click', closeNav);
    overlay?.addEventListener('click', closeNav);

    nav.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        if(window.matchMedia('(max-width: 920px)').matches) {
          closeNav();
        }
      });
    });

    document.addEventListener('keydown', (event) => {
      if(event.key === 'Escape' && isOpen()) {
        closeNav();
      }
    });
  })();
</script>