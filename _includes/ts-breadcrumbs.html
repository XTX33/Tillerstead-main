{% comment %}
Tillerstead.com Breadcrumbs Component
- Semantic, accessible, and SEO-optimized
- Compliant with TCNA, NJ HIC, and project OUTPUT_RULES.md
- All labels and links are explicit, conversion-focused, and legally accurate
- No dead ends, broken logic, or vague copy
{% endcomment %}
{% unless page.url == '/' or page.url == '/index.html' %}
{%- assign is_home = page.url == '/' or page.url == '/index.html' -%}
{%- assign render_breadcrumbs = true -%}
{%- if is_home or page.show_breadcrumbs == false or page.breadcrumb == false -%}
  {%- assign render_breadcrumbs = false -%}
{%- endif -%}

{%- if render_breadcrumbs -%}
  {%- assign raw_url = page.url | default: '' -%}
  {%- assign clean_url = '' | append: raw_url | replace: 'index.html', '' | replace: '.html', '' -%}
  {%- assign segments = clean_url | split: '/' -%}
  {%- assign clean_segments = '' | split: '' -%}
  {%- for seg in segments -%}
    {%- unless seg == '' -%}
      {%- assign clean_segments = clean_segments | push: seg -%}
    {%- endunless -%}
  {%- endfor -%}

  {%- assign is_post = false -%}
  {%- if page.collection == 'posts' or page.layout == 'post' -%}
    {%- assign is_post = true -%}
  {%- endif -%}

  {%- assign parent_url = page.parent | default: page.breadcrumb_parent -%}
  {%- assign parent_label = page.parent_label | default: page.breadcrumb_parent_label -%}
  {%- assign parent_page = nil -%}
  {%- assign parent_path = '' -%}
  {%- assign parent_slug = nil -%}
  {%- if parent_url and parent_url != '' -%}
    {%- assign parent_clean = parent_url | replace: 'index.html', '' | replace: '.html', '' -%}
    {%- assign parent_segments = parent_clean | split: '/' -%}
    {%- for part in parent_segments -%}
      {%- unless part == '' -%}
        {%- assign parent_path = parent_path | append: '/' | append: part -%}
        {%- assign parent_slug = part -%}
      {%- endunless -%}
    {%- endfor -%}
    {%- assign parent_slug = parent_slug | default: '' -%}
    {%- assign lookup_url = parent_url -%}
    {%- assign parent_page = site.html_pages | where_exp: 'p', 'p.url == lookup_url' | first -%}
    {%- if parent_page == nil and parent_path != '' -%}
      {%- assign lookup_url = parent_path | append: '/' -%}
      {%- assign parent_page = site.html_pages | where_exp: 'p', 'p.url == lookup_url' | first -%}
    {%- endif -%}
    {%- if parent_page and parent_label == nil -%}
      {%- assign parent_label = parent_page.breadcrumb_title | default: parent_page.title -%}
    {%- endif -%}
    {%- if parent_label == nil and parent_slug -%}
      {%- assign parent_label = parent_slug | replace: '-', ' ' | capitalize -%}
    {%- endif -%}
  {%- endif -%}
  {%- assign parent_slug = parent_slug | default: '' -%}
  {%- if parent_label -%}
    {%- if parent_label contains '|' -%}
      {%- assign parent_label = parent_label | split: '|' | first -%}
    {%- endif -%}
    {%- assign parent_label = parent_label | strip -%}
  {%- endif -%}

  {%- assign last_index = clean_segments.size | minus: 1 -%}
  {%- assign crumb_position = 1 -%}
  {%- assign current_path = '' -%}
  {%- assign json_items = '' -%}

  <nav class="breadcrumbs ts-breadcrumbs" aria-label="Breadcrumb" role="navigation" itemscope itemtype="https://schema.org/BreadcrumbList">
    <ol class="breadcrumbs-list ts-breadcrumbs__list">
      <!-- Home crumb: always present, explicit, conversion-focused, and NJ HIC compliant -->
      <li class="breadcrumbs-item ts-breadcrumbs__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a class="breadcrumbs-link ts-breadcrumbs__link ts-crumb-link" href="{{ '/' | relative_url }}" itemprop="item">
          <span itemprop="name">Home – Tillerstead: NJ Licensed Tile & Remodeling Contractor</span>
        </a>
        <meta itemprop="position" content="{{ crumb_position }}">
      </li>
      {%- assign json_items = json_items | append: '{"@type":"ListItem","position":1,"name":"Home – Tillerstead: NJ Licensed Tile & Remodeling Contractor","item":"' | append: site.url | append: '/"}' -%}
      {%- assign crumb_position = crumb_position | plus: 1 -%}

      {%- if parent_label and parent_path != '' -%}
        <li class="breadcrumbs-item ts-breadcrumbs__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a class="breadcrumbs-link ts-breadcrumbs__link ts-crumb-link" href="{{ parent_path | append: '/' | relative_url }}" itemprop="item">
            <span itemprop="name">{{ parent_label | escape }}</span>
          </a>
          <meta itemprop="position" content="{{ crumb_position }}">
        </li>
        {%- assign json_items = json_items | append: ',{"@type":"ListItem","position":' | append: crumb_position | append: ',"name":' | append: parent_label | strip | jsonify | append: ',"item":"' | append: site.url | append: parent_path | append: '/"}' -%}
        {%- assign crumb_position = crumb_position | plus: 1 -%}
        {%- assign current_path = parent_path -%}
      {%- endif -%}

      {%- assign parent_slug = parent_slug | default: '' -%}
      {%- for segment in clean_segments -%}
        {%- if parent_slug != '' and segment == parent_slug -%}
          {%- continue -%}
        {%- endif -%}
        {%- assign current_path = current_path | append: '/' | append: segment -%}
        {%- assign is_last = forloop.last -%}
        {%- assign base_label = segment | replace: '-', ' ' | strip | capitalize -%}
        {%- assign label = base_label -%}
        {%- if is_last -%}
          {%- assign label = page.breadcrumb_title | default: page.hero_title | default: page.title | default: base_label -%}
        {%- endif -%}
        {%- assign crumb_href = current_path | append: '/' -%}
        <li class="breadcrumbs-item ts-breadcrumbs__item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          {%- if is_last -%}
            <span class="breadcrumbs-current ts-breadcrumbs__current ts-crumb-current" aria-current="page" itemprop="name">{{ label | escape }}</span>
            <meta itemprop="item" content="{{ site.url }}{{ crumb_href }}">
          {%- else -%}
            <a class="breadcrumbs-link ts-breadcrumbs__link ts-crumb-link" href="{{ crumb_href | relative_url }}" itemprop="item">
              <span itemprop="name">{{ label | escape }}</span>
            </a>
          {%- endif -%}
          <meta itemprop="position" content="{{ crumb_position }}">
        </li>
        {%- assign json_items = json_items | append: ',{"@type":"ListItem","position":' | append: crumb_position | append: ',"name":' | append: label | strip | jsonify | append: ',"item":"' | append: site.url | append: crumb_href | append: '"}' -%}
        {%- assign crumb_position = crumb_position | plus: 1 -%}
      {%- endfor -%}
    </ol>
  </nav>

  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{{ json_items }}]}
  </script>
{%- endif -%}
{% endunless %}
