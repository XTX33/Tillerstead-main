name: Delete All Branches Except Main

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  noop:
    name: No-op (required check)
    runs-on: ubuntu-latest
    steps:
      - run: echo "No-op on push/PR; branch deletion is manual via workflow_dispatch only."

  delete-branches:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4.1.2
        with:
          fetch-depth: 0

      - name: Delete all remote branches except main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # Tillerstead LLC - Branch Hygiene (TCNA/NJ HIC Compliant)
          # This script removes all remote branches except 'main' to ensure codebase integrity and regulatory compliance.
          # See /.ai/OUTPUT_RULES.md for naming and operational standards.

          set -euo pipefail

          echo "=========================================="
          echo "Tillerstead Branch Deletion Workflow"
          echo "=========================================="
          echo "Fetching all remote branches for authoritative cleanup..."
          git fetch --all --prune

          # List all remote branches except main and HEAD
          branches_to_delete=$(git for-each-ref --format='%(refname:short)' refs/remotes/origin/ \
            | grep -v '^origin/HEAD$' \
            | grep -v '^origin/main$' \
            | sed 's|^origin/||' || true)

          if [ -z "$branches_to_delete" ]; then
            echo "✓ No branches to delete (only main exists)."
            exit 0
          fi

          echo "Branches scheduled for deletion:"
          echo "------------------------------------------"
          echo "$branches_to_delete"
          echo "------------------------------------------"

          success_count=0
          fail_count=0

          for branch in $branches_to_delete; do
            echo "Deleting remote branch: $branch"
            if git push origin --delete "$branch"; then
              echo "✓ Successfully deleted: $branch"
              success_count=$((success_count + 1))
            else
              echo "✗ Failed to delete: $branch"
              fail_count=$((fail_count + 1))
            fi
          done

          echo ""
          echo "=========================================="
          echo "Branch deletion complete!"
          echo "Successfully deleted: $success_count"
          echo "Failed: $fail_count"
          echo "=========================================="
