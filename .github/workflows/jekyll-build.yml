name: Jekyll Build Verification

on:
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build and Validate Static Site (TCNA/NJ HIC Compliant)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Ruby (TCNA/NJ HIC Standards)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'
          bundler: '2.4.19'
          bundler-cache: true

      - name: Set Up Node.js (Linting & Asset Pipeline)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node.js Dependencies
        run: npm ci

      - name: Lint JavaScript (ESLint, TCNA/NJ HIC Compliance)
        run: npx eslint .

      - name: Lint HTML (HTMLHint, Accessibility & SEO)
        run: npx htmlhint "**/*.html"

      - name: Build CSS Assets (Design Tokens, Accessibility)
        run: npm run build:css

      - name: Install Ruby Dependencies (Vendored Jekyll)
        run: bundle install --local

      - name: Build Site with Jekyll (Trace for Debugging)
        env:
          JEKYLL_ENV: production
        run: bundle exec jekyll build --trace

      - name: Validate Generated HTML (Accessibility, SEO, Legal)
        run: npx htmlhint "_site/**/*.html"

      - name: Check for Broken Internal Links (No Dead Ends)
        run: node scripts/check-links.js

      - name: Verify Performance Targets (LCP, CLS, TTI)
        run: node scripts/perf-check.js || echo "Performance check script not present; skipping."

      - name: Ensure All Images Have Descriptive Alt Text (WCAG/NJ HIC)
        run: node scripts/check-alt-text.js || echo "Alt text check script not present; skipping."

